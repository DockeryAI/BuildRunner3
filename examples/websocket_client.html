<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BuildRunner WebSocket Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 20px;
            color: #4CAF50;
        }

        .controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #b0b0b0;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        button:hover {
            background: #45a049;
        }

        button.disconnect {
            background: #f44336;
        }

        button.disconnect:hover {
            background: #da190b;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }

        .status.connected {
            background: #2e7d32;
        }

        .status.disconnected {
            background: #c62828;
        }

        .messages {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            height: 500px;
            overflow-y: auto;
        }

        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border-left: 3px solid #4CAF50;
        }

        .message.connection {
            background: #1e3a1e;
            border-left-color: #4CAF50;
        }

        .message.component_update {
            background: #1a2a3a;
            border-left-color: #2196F3;
        }

        .message.checkpoint_update {
            background: #3a2a1a;
            border-left-color: #FF9800;
        }

        .message.terminal_output {
            background: #2a2a2a;
            border-left-color: #9E9E9E;
        }

        .message.build_progress {
            background: #2a1a3a;
            border-left-color: #9C27B0;
        }

        .message.error {
            background: #3a1a1a;
            border-left-color: #f44336;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #4CAF50;
        }

        .message-time {
            color: #808080;
            font-size: 11px;
        }

        .message-content {
            color: #e0e0e0;
            white-space: pre-wrap;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #4CAF50;
        }

        .stat-label {
            color: #b0b0b0;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BuildRunner WebSocket Monitor</h1>

        <div class="controls">
            <div class="control-group">
                <label for="wsUrl">WebSocket URL:</label>
                <input type="text" id="wsUrl" value="ws://localhost:8000/api/build/stream/example_session">
            </div>

            <button id="connectBtn" onclick="connect()">Connect</button>
            <button id="disconnectBtn" class="disconnect" onclick="disconnect()" disabled>Disconnect</button>
            <button onclick="sendPing()">Send Ping</button>
            <button onclick="clearMessages()">Clear</button>

            <div id="status" class="status disconnected">Disconnected</div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Messages Received</div>
                <div class="stat-value" id="messageCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Build Progress</div>
                <div class="stat-value" id="buildProgress">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Components</div>
                <div class="stat-value" id="componentCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Connection Time</div>
                <div class="stat-value" id="connectionTime">-</div>
            </div>
        </div>

        <div class="messages" id="messages"></div>
    </div>

    <script>
        let ws = null;
        let messageCount = 0;
        let connectionTime = null;
        let componentCount = 0;

        function connect() {
            const url = document.getElementById('wsUrl').value;

            try {
                ws = new WebSocket(url);

                ws.onopen = () => {
                    updateStatus('connected', 'Connected');
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    connectionTime = new Date();
                    updateConnectionTime();
                    addMessage('connection', 'System', 'Connected to ' + url);
                };

                ws.onclose = () => {
                    updateStatus('disconnected', 'Disconnected');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    addMessage('error', 'System', 'Connection closed');
                };

                ws.onerror = (error) => {
                    addMessage('error', 'System', 'WebSocket error: ' + error);
                };

                ws.onmessage = (event) => {
                    messageCount++;
                    document.getElementById('messageCount').textContent = messageCount;

                    try {
                        const data = JSON.parse(event.data);
                        handleMessage(data);
                    } catch (e) {
                        addMessage('error', 'System', 'Failed to parse message: ' + e);
                    }
                };

            } catch (e) {
                addMessage('error', 'System', 'Connection failed: ' + e);
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping' }));
                addMessage('connection', 'Client', 'Sent ping');
            }
        }

        function handleMessage(data) {
            const type = data.type || 'unknown';

            switch (type) {
                case 'connection':
                    addMessage('connection', 'Server', data.message || 'Connected');
                    break;

                case 'pong':
                    addMessage('connection', 'Server', 'Pong received');
                    break;

                case 'component_update':
                    componentCount++;
                    document.getElementById('componentCount').textContent = componentCount;
                    addMessage(
                        'component_update',
                        'Component: ' + data.component_id,
                        `Status: ${data.status}, Progress: ${data.progress}%`
                    );
                    break;

                case 'checkpoint_update':
                    addMessage(
                        'checkpoint_update',
                        'Checkpoint: ' + data.checkpoint_id,
                        `Phase: ${data.phase}, Tasks: ${data.tasks_completed.length}, Files: ${data.files_created.length}`
                    );
                    break;

                case 'terminal_output':
                    addMessage('terminal_output', 'Terminal', data.output);
                    break;

                case 'build_progress':
                    const percent = data.percent || 0;
                    document.getElementById('buildProgress').textContent = percent.toFixed(1) + '%';
                    addMessage(
                        'build_progress',
                        'Progress',
                        `${data.completed}/${data.total} components (${percent.toFixed(1)}%)`
                    );
                    break;

                case 'error':
                    addMessage('error', 'Error', data.error_message || data.error || 'Unknown error');
                    break;

                default:
                    addMessage('connection', 'Message', JSON.stringify(data, null, 2));
            }
        }

        function addMessage(type, header, content) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + type;

            const now = new Date().toLocaleTimeString();

            messageDiv.innerHTML = `
                <div class="message-header">${header} <span class="message-time">${now}</span></div>
                <div class="message-content">${content}</div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateStatus(status, text) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status ' + status;
            statusDiv.textContent = text;
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            messageCount = 0;
            componentCount = 0;
            document.getElementById('messageCount').textContent = '0';
            document.getElementById('componentCount').textContent = '0';
            document.getElementById('buildProgress').textContent = '0%';
        }

        function updateConnectionTime() {
            if (connectionTime && ws && ws.readyState === WebSocket.OPEN) {
                const elapsed = Math.floor((new Date() - connectionTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('connectionTime').textContent =
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                setTimeout(updateConnectionTime, 1000);
            } else {
                document.getElementById('connectionTime').textContent = '-';
            }
        }
    </script>
</body>
</html>
